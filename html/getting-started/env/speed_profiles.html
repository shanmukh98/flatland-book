
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Speed profiles</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/custom.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      <img src="../../_static/flatland-logo.svg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/intro.html">
   Welcome to Flatland
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/getting-started/installation.html">
   Installing Flatland
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/getting-started/env.html">
   Flatland Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/getting-started/The_Rail_Environment.html">
   Using
   <code class="docutils literal notranslate">
    <span class="pre">
     RailEnv
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/getting-started/sequential-agent.html">
   Sequential Agent
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Environment
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/env/observations.html">
   Provided Observations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/env/level_generation.html">
   Level Generation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/env/environment_information.html">
   Environment information
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/env/custom_observations.html">
   Custom observations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/env/speed_profiles.html">
   Speed profiles
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../book/env/updates.html">
   Updates
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/env/updates/Agent-Close-Following.html">
     Unordered Close Following
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://flatlandrl-docs.aicrowd.com/flatland.html">
   API Reference
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/tuts/or.html">
   Operations Research
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../book/tuts/rl.html">
   Reinforcement Learning
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/tuts/rl/single-agent.html">
     Single agent
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/tuts/rl/multi-agent.html">
     Multiple Agents
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Challenges
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../book/challenges/amld2021.html">
   AMLD 2021
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/amld2021/envconfig.html">
     Environment Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/amld2021/eval.html">
     Evaluation Metrics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/amld2021/first-submission.html">
     Making a Submission
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../book/challenges/neurips2020-challenge.html">
   Neurips 2020
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/neurips2020/envconfig.html">
     Environment Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/neurips2020/eval.html">
     Evaluation Metrics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/neurips2020/first-submission.html">
     Making a Submission
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/challenges/neurips2020/faq.html">
     FAQs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/challenges/halloffame.html">
   Hall of Fame
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Research
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../book/research/baselines.html">
   RLlib Baselines
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/research/baselines/getting-started.html">
     Getting started
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/research/baselines/centralized_critic.html">
     Centralized Critic PPO
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/research/baselines/imitation_learning.html">
     Imitation Learning Training
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/research/baselines/global_density_obs.html">
     Global Density Observation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/research/baselines/combined_tree_local_conflict_obs.html">
     Combined Observation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/research/baselines/action_masking_and_skipping.html">
     Frame skipping and action masking
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/research/research-ideas.html">
   Research Ideas
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  FAQ
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/faq/env.html">
   Flatland Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/faq/research.html">
   Flatland Research
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Miscellaneous
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/misc/external-resources.html">
   Community Projects
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../book/misc/contributing.html">
   Contributing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/misc/contributing-code.html">
     Writing code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../book/misc/contributing-doc.html">
     Writing documentation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../book/misc/credits.html">
   Credits
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/getting-started/env/speed_profiles.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#actions-and-observation-with-different-speed-levels">
   Actions and observation with different speed levels
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rail-generators-and-schedule-generators">
   Rail Generators and Schedule Generators
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="speed-profiles">
<h1>Speed profiles<a class="headerlink" href="#speed-profiles" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Speed profiles are not used in the <a class="reference external" href="https://www.aicrowd.com/challenges/neurips-2020-flatland-challenge/">NeurIPS 2020 challenge</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This page is outdated and needs to be reviewed, handle with care.</p>
</div>
<p>One of the main contributions to the complexity of railway network operations stems from the fact that all trains travel at different speeds while sharing a very limited railway network.
In <strong>Flat</strong>land 2.0 this feature will be enabled as well and will lead to much more complex configurations. Here we count on your support if you find bugs or improvements  :).</p>
<p>The different speed profiles can be generated using the <code class="docutils literal notranslate"><span class="pre">schedule_generator</span></code>, where you can actually chose as many different speeds as you like.
Keep in mind that the <em>fastest speed</em> is 1 and all slower speeds must be between 1 and 0.
For the submission scoring you can assume that there will be no more than 5 speed profiles.</p>
<p>Later versions of <strong>Flat</strong>land might have varying speeds during episodes. Therefore, we return the agent speeds.
Notice that we do not guarantee that the speed will be computed at each step, but if not costly we will return it at each step.
In your controller, you can get the agents’ speed from the <code class="docutils literal notranslate"><span class="pre">info</span></code> returned by <code class="docutils literal notranslate"><span class="pre">step</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span><span class="p">,</span> <span class="n">rew</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
<span class="o">...</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get_num_agents</span><span class="p">()):</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;speed&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="actions-and-observation-with-different-speed-levels">
<h2>Actions and observation with different speed levels<a class="headerlink" href="#actions-and-observation-with-different-speed-levels" title="Permalink to this headline">¶</a></h2>
<p>Because the different speeds are implemented as fractions the agents ability to perform actions has been updated.
We **do not allow actions to change within the cell **.
This means that each agent can only chose an action to be taken when entering a cell.
This action is then executed when a step to the next cell is valid. For example</p>
<ul class="simple">
<li><p>Agent enters switch and choses to deviate left. Agent fractional speed is 1/4 and thus the agent will take 4 time steps to complete its journey through the cell. On the 4th time step the agent will leave the cell deviating left as chosen at the entry of the cell.</p>
<ul>
<li><p>All actions chosen by the agent during its travels within a cell are ignored</p></li>
<li><p>Agents can make observations at any time step. Make sure to discard observations without any information. See this <a class="reference external" href="https://gitlab.aicrowd.com/flatland/baselines/blob/master/torch_training/training_navigation.py">example</a> for a simple implementation.</p></li>
</ul>
</li>
<li><p>The environment checks if agent is allowed to move to next cell only at the time of the switch to the next cell</p></li>
</ul>
<p>In your controller, you can check whether an agent requires an action by checking <code class="docutils literal notranslate"><span class="pre">info</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span><span class="p">,</span> <span class="n">rew</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">action_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get_num_agents</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;action_required&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;malfunction&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">action_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="p">:</span> <span class="o">...</span><span class="p">})</span>

</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">info['action_required'][a]</span></code> does not mean that the action will have an effect:
if the next cell is blocked or the agent breaks down, the action cannot be performed and an action will be required again in the next step.</p>
</div>
<div class="section" id="rail-generators-and-schedule-generators">
<h2>Rail Generators and Schedule Generators<a class="headerlink" href="#rail-generators-and-schedule-generators" title="Permalink to this headline">¶</a></h2>
<p>The separation between rail generator and schedule generator reflects the organisational separation in the railway domain</p>
<ul class="simple">
<li><p>Infrastructure Manager (IM): is responsible for the layout and maintenance of tracks</p></li>
<li><p>Railway Undertaking (RU): operates trains on the infrastructure
Usually, there is a third organisation, which ensures discrimination-free access to the infrastructure for concurrent requests for the infrastructure in a <strong>schedule planning phase</strong>.
However, in the <strong>Flat</strong>land challenge, we focus on the re-scheduling problem during live operations.</p></li>
</ul>
<p>Technically,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RailGeneratorProduct</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">GridTransitionMap</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
<span class="n">RailGenerator</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">RailGeneratorProduct</span><span class="p">]</span>

<span class="n">AgentPosition</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="n">Schedule</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Schedule&#39;</span><span class="p">,</span>   <span class="s1">&#39;agent_positions &#39;</span>
                                                <span class="s1">&#39;agent_directions &#39;</span>
                                                <span class="s1">&#39;agent_targets &#39;</span>
                                                <span class="s1">&#39;agent_speeds &#39;</span>
                                                <span class="s1">&#39;agent_malfunction_rates &#39;</span>
                                                <span class="s1">&#39;max_episode_steps&#39;</span><span class="p">)</span>
<span class="n">ScheduleGenerator</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">GridTransitionMap</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">Schedule</span><span class="p">]</span>
</pre></div>
</div>
<p>We can then produce <code class="docutils literal notranslate"><span class="pre">RailGenerator</span></code>s by currying:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sparse_rail_generator</span><span class="p">(</span><span class="n">num_cities</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_intersections</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_trainstations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_node_dist</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">node_radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">num_neighb</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">grid_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enhance_intersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">num_agents</span><span class="p">,</span> <span class="n">num_resets</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># generate the grid and (optionally) some hints for the schedule_generator</span>
        <span class="o">...</span>

        <span class="k">return</span> <span class="n">grid_map</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;agents_hints&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;num_agents&#39;</span><span class="p">:</span> <span class="n">num_agents</span><span class="p">,</span>
            <span class="s1">&#39;agent_start_targets_nodes&#39;</span><span class="p">:</span> <span class="n">agent_start_targets_nodes</span><span class="p">,</span>
            <span class="s1">&#39;train_stations&#39;</span><span class="p">:</span> <span class="n">train_stations</span>
        <span class="p">}}</span>

    <span class="k">return</span> <span class="n">generator</span>
</pre></div>
</div>
<p>And, similarly, <code class="docutils literal notranslate"><span class="pre">ScheduleGenerator</span></code>s:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sparse_schedule_generator</span><span class="p">(</span><span class="n">speed_ratio_map</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScheduleGenerator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">rail</span><span class="p">:</span> <span class="n">GridTransitionMap</span><span class="p">,</span> <span class="n">num_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hints</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># place agents:</span>
        <span class="c1"># - initial position</span>
        <span class="c1"># - initial direction</span>
        <span class="c1"># - (initial) speed</span>
        <span class="c1"># - malfunction</span>
        <span class="o">...</span>

        <span class="k">return</span> <span class="n">agents_position</span><span class="p">,</span> <span class="n">agents_direction</span><span class="p">,</span> <span class="n">agents_target</span><span class="p">,</span> <span class="n">speeds</span><span class="p">,</span> <span class="n">agents_malfunction</span>

    <span class="k">return</span> <span class="n">generator</span>
</pre></div>
</div>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">rail_generator</span></code> may pass <code class="docutils literal notranslate"><span class="pre">agents_hints</span></code> to the  <code class="docutils literal notranslate"><span class="pre">schedule_generator</span></code> which the latter may interpret.
For instance, the way the <code class="docutils literal notranslate"><span class="pre">sparse_rail_generator</span></code> generates the grid, it already determines the agent’s goal and target.
Hence, <code class="docutils literal notranslate"><span class="pre">rail_generator</span></code> and <code class="docutils literal notranslate"><span class="pre">schedule_generator</span></code> have to match if <code class="docutils literal notranslate"><span class="pre">schedule_generator</span></code> presupposes some specific <code class="docutils literal notranslate"><span class="pre">agents_hints</span></code>.</p>
<p>The environment’s <code class="docutils literal notranslate"><span class="pre">reset</span></code> takes care of applying the two generators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="o">...</span>
             <span class="n">rail_generator</span><span class="p">:</span> <span class="n">RailGenerator</span> <span class="o">=</span> <span class="n">random_rail_generator</span><span class="p">(),</span>
             <span class="n">schedule_generator</span><span class="p">:</span> <span class="n">ScheduleGenerator</span> <span class="o">=</span> <span class="n">random_schedule_generator</span><span class="p">(),</span>
             <span class="o">...</span>
             <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rail_generator</span><span class="p">:</span> <span class="n">RailGenerator</span> <span class="o">=</span> <span class="n">rail_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_generator</span><span class="p">:</span> <span class="n">ScheduleGenerator</span> <span class="o">=</span> <span class="n">schedule_generator</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regenerate_rail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regenerate_schedule</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rail</span><span class="p">,</span> <span class="n">optionals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rail_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_agents</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_resets</span><span class="p">)</span>

        <span class="o">...</span>

        <span class="k">if</span> <span class="n">replace_agents</span><span class="p">:</span>
            <span class="n">agents_hints</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">optionals</span> <span class="ow">and</span> <span class="s1">&#39;agents_hints&#39;</span> <span class="ow">in</span> <span class="n">optionals</span><span class="p">:</span>
                <span class="n">agents_hints</span> <span class="o">=</span> <span class="n">optionals</span><span class="p">[</span><span class="s1">&#39;agents_hints&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents_static</span> <span class="o">=</span> <span class="n">EnvAgentStatic</span><span class="o">.</span><span class="n">from_lists</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rail</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_agents</span><span class="p">(),</span> <span class="n">hints</span><span class="o">=</span><span class="n">agents_hints</span><span class="p">))</span>
</pre></div>
</div>
<p>To see all the changes in action you can just run the <code class="docutils literal notranslate"><span class="pre">flatland_example_2_0.py</span></code> file in the examples folder. The file can be found <a class="reference external" href="https://gitlab.aicrowd.com/flatland/flatland/blob/master/examples/flatland_2_0_example.py">here</a>.</p>
</div>
</div>


              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Flatland Community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-132885496-4', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>